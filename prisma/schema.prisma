generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGO_URL_MONGODB_URI")
}

enum Role {
  MASTER
  GERENTE_SENIOR
  GERENTE_NEGOCIOS
  PROPRIETARIO
  CONSULTOR
}

enum Profile {
  MASTER
  GERENTE_SENIOR
  GERENTE_NEGOCIOS
  PROPRIETARIO
  CONSULTOR
}

enum Office {
  SAFE_TI
  JLC_TECH
  KING
}

enum LeadStatus {
  NOVO
  EM_CONTATO
  EM_NEGOCIACAO
  FECHADO
  PERDIDO
}

enum CampaignType {
  COCKPIT
  MAPA_PARQUE
}

enum ActivityChannel {
  TELEFONE
  WHATSAPP
  EMAIL
  VISITA
  OUTRO
}

model User {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  email        String        @unique
  password     String
  role         Role
  profile      Profile
  office       Office
  officeRecordId String?       @map("officeId") @db.ObjectId
  officeRecord   OfficeRecord? @relation("OfficeUsers", fields: [officeRecordId], references: [id])
  ownerId      String?       @db.ObjectId
  owner        User?         @relation("OwnerConsultor", fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  consultores  User[]        @relation("OwnerConsultor")
  seniorId     String?       @db.ObjectId
  senior       User?         @relation("SeniorToGN", fields: [seniorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  managers     User[]        @relation("SeniorToGN")
  offices      UserOffice[]
  managedOffices ManagerOffice[] @relation("ManagerOffices")
  seniorManagedOffices   OfficeRecord[] @relation("OfficeSeniorManager")
  businessManagedOffices OfficeRecord[] @relation("OfficeBusinessManager")
  ownedOffices           OfficeRecord[] @relation("OfficeOwner")
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  leadsAssigned              Lead[]            @relation("AssignedLeads")
  leadsOwned                 Lead[]            @relation("LeadOwner")
  leadActivities             LeadActivity[]    @relation("UserLeadActivities")
  importBatches              ImportBatch[]     @relation("UserImportBatches")
  leadNotes                  LeadNote[]
  leadLosses                 LeadLoss[]
  adminDistributionLogs      DistributionLog[] @relation("AdminDistributionLog")
  consultantDistributionLogs DistributionLog[] @relation("ConsultantDistributionLog")
  leadHistories              LeadHistory[]     @relation("UserLeadHistory")
  leadEvents                 LeadEvent[]       @relation("UserLeadEvents")
  campanhasGN                Campanha[]        @relation("CampanhaGN")
  campanhasGS                Campanha[]        @relation("CampanhaGS")
  campanhasOwner             Campanha[]        @relation("CampanhaOwner")
  createdAnnouncements       Announcement[]    @relation("CreatedAnnouncements")
  readAnnouncements          AnnouncementRead[]
}

model Campanha {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  nome           String
  descricao      String?
  parceiro       String?
  objetivo       String?
  vertical       String?
  regiaoUf       String?
  regiaoCidade   String?
  observacoes    String?
  status         String?   @default("ATIVA")
  type           CampaignType @default(COCKPIT)
  tipo           CampaignType @default(COCKPIT)
  office         Office    @default(SAFE_TI)
  officeIDs      String[]  @db.ObjectId
  officeRecords  OfficeRecord[] @relation("CampanhaOffices", fields: [officeIDs], references: [id])
  periodoInicio  DateTime?
  periodoFim     DateTime?
  createdAt      DateTime  @default(now())
  createdById    String?   @db.ObjectId
  createdBy      User?     @relation("CampanhaOwner", fields: [createdById], references: [id])
  gnId           String?   @db.ObjectId
  gn             User?     @relation("CampanhaGN", fields: [gnId], references: [id])
  gsId           String?   @db.ObjectId
  gs             User?     @relation("CampanhaGS", fields: [gsId], references: [id])
  ownerId        String?   @db.ObjectId

  totalLeads     Int       @default(0)
  assignedLeads  Int       @default(0)
  remainingLeads Int       @default(0)
  isActive       Boolean   @default(true)

  leads       Lead[]            @relation("CampanhaLeads")
  importBatches    ImportBatch[]
  activities       LeadActivity[]
  distributionLogs DistributionLog[] @relation("CampanhaDistributionLogs")
}

model Lead {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  campanhaId    String       @db.ObjectId
  campanha      Campanha     @relation("CampanhaLeads", fields: [campanhaId], references: [id])
  importBatchId String?      @db.ObjectId
  importBatch   ImportBatch? @relation(fields: [importBatchId], references: [id])

  type          CampaignType?

  // COCKPIT Fields
  UF                 String?
  CIDADE             String?
  DOCUMENTO          String?
  EMPRESA            String?
  CD_CNAE            String?
  VL_FAT_PRESUMIDO   String? // Keeping as String for safety with imports, can be Float if strictly controlled
  TELEFONE1          String?
  TELEFONE2          String?
  TELEFONE3          String?
  LOGRADOURO         String?
  TERRITORIO         String?
  OFERTA_MKT         String?
  CEP                String?
  NUMERO             String?
  ESTRATEGIA         String?
  ARMARIO            String?
  ID_PRUMA           String?
  VERTICAL_COCKPIT   String?

  // MAPA PARQUE Fields
  NR_CNPJ                          String?
  NM_CLIENTE                       String?
  TP_PRODUTO                       String?
  QT_MOVEL_TERM                    Int?
  QT_MOVEL_PEN                     Int?
  QT_MOVEL_M2M                     Int?
  QT_BASICA_TERM_FIBRA             Int?
  QT_BASICA_TERM_METALICO          Int?
  QT_BASICA_BL                     Int?
  QT_BL_FTTH                       Int?
  QT_BL_FTTC                       Int?
  QT_BASICA_TV                     Int?
  QT_BASICA_OUTROS                 Int?
  QT_BASICA_LINAS                  Int?
  QT_AVANCADA_DADOS                Int?
  AVANCADA_VOZ                     Int?
  QT_VIVO_TECH                     Int?
  QT_VVN                           Int?
  DS_ENDERECO                      String?
  DS_CIDADE                        String?
  NR_CEP                           String?
  NUMERO_MP                        String?
  NM_CONTATO_SFA                   String?
  EMAIL_CONTATO_PRINCIPAL_SFA      String?
  CELULAR_CONTATO_PRINCIPAL_SFA    String?
  TLFN_1                           String?
  TLFN_2                           String?
  TLFN_3                           String?
  TLFN_4                           String?
  TLFN_5                           String?
  TEL_COMERCIAL_SIEBEL             String?
  TEL_CELULAR_SIEBEL               String?
  TEL_RESIDENCIAL_SIEBEL           String?
  NOMEREDE                         String?
  VERTICAL_MP                      String?
  DATA_FIM_VTECH                   DateTime?
  FLG_TROCA_VTECH                  String?


  // Legacy / Shared Fields (keeping for compatibility)
  cnpj           String?
  documento      String?
  razaoSocial    String?
  nomeFantasia   String?
  vertical       String?
  cidade         String?
  estado         String?
  telefone       String?
  email          String?
  telefone1      String?
  telefone2      String?
  telefone3      String?
  logradouro     String?
  numero         String?
  bairro         String?
  cep            String?
  endereco       String?
  territorio     String?
  ofertaMkt      String?
  estrategia     String?
  armario        String?
  idPruma        String?
  vlFatPresumido String?
  cnae           String?
 
  status             LeadStatus    @default(NOVO)
  consultorId        String?       @db.ObjectId
  consultor          User?         @relation("AssignedLeads", fields: [consultorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ownerId            String?       @db.ObjectId
  owner              User?         @relation("LeadOwner", fields: [ownerId], references: [id])
  officeId           String?       @db.ObjectId
  officeRecord       OfficeRecord? @relation(fields: [officeId], references: [id])
  escritorio         Office        @default(SAFE_TI)
  assignedToId        String?
  previousConsultants String[]     @default([])
  lastActivityDate    DateTime?
  historico          Json?
  raw                Json?
  lastStatusChangeAt DateTime?
  lastInteractionAt  DateTime?
  interactionCount   Int           @default(0)
  isWorked           Boolean       @default(false)
  lastActivityAt     DateTime?
  lastOutcomeCode    String?
  lastOutcomeLabel   String?
  lastOutcomeNote    String?
  nextFollowUpAt     DateTime?
  nextStepNote       String?
  telefones          Json?
  emails             String[]
  lostReason         String?
  lostReasonComment  String?
  lostAt             DateTime?
  site               String?
  contatoPrincipal   Json?
  observacoesGerais  String?
  origem             String?
  externalData       Json?
  productCart        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  activities LeadActivity[]
  events     LeadEvent[]
  enrichmentSuggestions LeadEnrichmentSuggestion[]
  notes      LeadNote[]
  losses     LeadLoss[]
  histories  LeadHistory[]  @relation("LeadToHistories")
}

model LeadEvent {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  leadId    String   @db.ObjectId
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation("UserLeadEvents", fields: [userId], references: [id], onDelete: Cascade)
  type      String
  payload   Json?
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([userId])
}

model LeadEnrichmentSuggestion {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  leadId    String   @db.ObjectId
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String
  source    String
  value     String
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
}

model OfficeRecord {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  code      String   @unique
  region    String?
  uf        String?
  city      String?
  notes     String?
  active    Boolean  @default(true)
  seniorManagerId   String? @db.ObjectId
  seniorManager     User?   @relation("OfficeSeniorManager", fields: [seniorManagerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  businessManagerId String? @db.ObjectId
  businessManager   User?   @relation("OfficeBusinessManager", fields: [businessManagerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ownerId           String? @db.ObjectId
  owner             User?   @relation("OfficeOwner", fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  office    Office?  @map("office")
  users     User[]   @relation("OfficeUsers")
  managers  ManagerOffice[] @relation("ManagerOffices")
  leads     Lead[]
  
  campanhaIDs String[]   @db.ObjectId
  campanhas   Campanha[] @relation("CampanhaOffices", fields: [campanhaIDs], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ManagerOffice {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  managerId      String       @db.ObjectId
  officeRecordId String       @db.ObjectId

  manager      User         @relation("ManagerOffices", fields: [managerId], references: [id], onDelete: Cascade)
  officeRecord OfficeRecord @relation("ManagerOffices", fields: [officeRecordId], references: [id], onDelete: Cascade)

  @@unique([managerId, officeRecordId])
}

model UserOffice {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  office    Office

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, office])
}

model LeadActivity {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  leadId         String           @db.ObjectId
  lead           Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId         String           @db.ObjectId
  user           User             @relation("UserLeadActivities", fields: [userId], references: [id])
  campaignId     String           @db.ObjectId
  campaign       Campanha         @relation(fields: [campaignId], references: [id])
  activityType   String
  channel        ActivityChannel?
  outcomeCode    String?
  outcomeLabel   String?
  note           String
  stageBefore    LeadStatus?
  stageAfter     LeadStatus?
  nextFollowUpAt DateTime?
  nextStepNote   String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([leadId])
  @@index([userId])
  @@index([campaignId])
}

model ImportBatch {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  nomeArquivoOriginal String
  fileName            String?
  campaignId          String   @db.ObjectId
  campaign            Campanha @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  totalLeads          Int
  importedLeads       Int      @default(0)
  attributedLeads     Int      @default(0)
  notAttributedLeads  Int      @default(0)
  duplicatedLeads     Int      @default(0)
  status              String   @default("completed")
  errorMessage        String?
  criadoPorId         String?  @db.ObjectId
  criadoPor           User?    @relation("UserImportBatches", fields: [criadoPorId], references: [id])
  createdAt           DateTime @default(now())
  leads               Lead[]
}

model DistributionLog {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  campaignId   String   @db.ObjectId
  adminId      String   @db.ObjectId
  consultantId String   @db.ObjectId
  leadIds      String[]
  rulesApplied String?
  createdAt    DateTime @default(now())

  campaign   Campanha @relation("CampanhaDistributionLogs", fields: [campaignId], references: [id])
  admin      User     @relation("AdminDistributionLog", fields: [adminId], references: [id])
  consultant User     @relation("ConsultantDistributionLog", fields: [consultantId], references: [id])
}

model LeadHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  leadId    String   @db.ObjectId
  lead      Lead     @relation("LeadToHistories", fields: [leadId], references: [id])
  action    String
  userId    String   @db.ObjectId
  user      User     @relation("UserLeadHistory", fields: [userId], references: [id])
  notes     String?
  fromUserId String?
  toUserId   String?
  byUserId   String?
  date      DateTime @default(now())
  createdAt DateTime @default(now())
}

model LeadNote {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  leadId    String   @db.ObjectId
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  tipo      String
  conteudo  String
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([userId])
}

model LeadLoss {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  leadId        String   @db.ObjectId
  lead          Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id])
  motivo        String
  justificativa String
  createdAt     DateTime @default(now())

  @@index([leadId])
  @@index([userId])
}

model Announcement {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  message     String
  imageUrl    String?
  active      Boolean  @default(true)
  createdById String   @db.ObjectId
  createdBy   User     @relation("CreatedAnnouncements", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  readers     AnnouncementRead[]
}

model AnnouncementRead {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  announcementId String       @db.ObjectId
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  readAt         DateTime     @default(now())

  @@unique([announcementId, userId])
}

model IntelligenceData {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  cnpj      String   @unique
  
  // Client Info
  codCliente     String?
  razaoSocial    String?
  nomeFantasia   String?
  endereco       String?
  numero         String?
  cep            String?
  bairro         String?
  cidade         String?
  uf             String?
  statusSfa      String?
  
  // Receita & Vertical
  situacaoReceita      String?
  vertical             String?
  atividadeEconomica   String?
  cnae                 String?
  
  // Hierarchy
  nomerede             String?
  nomeGn               String?
  nomeGerenteDivisao   String?
  loginConsultor       String?
  adabasMovel          String?
  adabasFixa           String?
  officeName           String? // Extracted from file
  
  // Vivo Plant (Numeric for filtering)
  qtMovelTerm          Int @default(0)
  qtMovelPen           Int @default(0)
  qtM2m                Int @default(0)
  qtFwt                Int @default(0)
  qtBasicaFibra        Int @default(0)
  qtBasicaMetalico     Int @default(0)
  qtBasicaBl           Int @default(0)
  qtBlFtth             Int @default(0)
  qtBlFttc             Int @default(0)
  qtBasicaTv           Int @default(0)
  qtBasicaOutros       Int @default(0)
  qtBasicaLinhas       Int @default(0)
  qtAvancadaDados      Int @default(0)
  qtAvancadaVoz        Int @default(0)
  qtVivoTech           Int @default(0)
  qtOffice365          Int @default(0)
  qtVvn                Int @default(0)
  
  // Coverage & Flags
  flgCobertura         String?
  dsDisponibilidade    String?
  flgMei               String?
  flgNaoPerturbe       String?
  flgCidDispVvn        String?
  flgErb               String?
  
  // Marketing
  trilha               String?
  primeiraOferta       String?
  segundaOferta        String?
  terceiraOferta       String?
  acaoMkt1             String?
  acaoMkt2             String?
  acaoMkt3             String?
  
  history              IntelligenceHistory[]
  
  updatedAt            DateTime @default(now())
  lastImportId         String? // Batch ID
}

model IntelligenceHistory {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  intelligenceDataId String  @db.ObjectId
  intelligenceData  IntelligenceData @relation(fields: [intelligenceDataId], references: [id], onDelete: Cascade)
  cnpj              String
  
  fieldChanged      String
  oldValue          String?
  newValue          String?
  
  changedAt         DateTime @default(now())
  importBatchId     String?
}
