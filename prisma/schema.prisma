generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGO_URL_MONGODB_URI")
}

enum Role {
  MASTER
  GERENTE_SENIOR
  GERENTE_NEGOCIOS
  PROPRIETARIO
  CONSULTOR
}

enum Profile {
  MASTER
  GERENTE_SENIOR
  GERENTE_NEGOCIOS
  PROPRIETARIO
  CONSULTOR
}

enum Office {
  SAFE_TI
  JLC_TECH
}

enum LeadStatus {
  NOVO
  EM_CONTATO
  EM_NEGOCIACAO
  FECHADO
  PERDIDO
}

enum ActivityChannel {
  TELEFONE
  WHATSAPP
  EMAIL
  VISITA
  OUTRO
}

model User {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  email        String        @unique
  password     String
  role         Role
  profile      Profile
  office       Office
  officeRecordId String?       @map("officeId") @db.ObjectId
  officeRecord   OfficeRecord? @relation("OfficeUsers", fields: [officeRecordId], references: [id])
  ownerId      String?       @db.ObjectId
  owner        User?         @relation("OwnerConsultor", fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  consultores  User[]        @relation("OwnerConsultor")
  seniorId     String?       @db.ObjectId
  senior       User?         @relation("SeniorToGN", fields: [seniorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  managers     User[]        @relation("SeniorToGN")
  offices      UserOffice[]
  managedOffices ManagerOffice[] @relation("ManagerOffices")
  seniorManagedOffices   OfficeRecord[] @relation("OfficeSeniorManager")
  businessManagedOffices OfficeRecord[] @relation("OfficeBusinessManager")
  ownedOffices           OfficeRecord[] @relation("OfficeOwner")
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  leadsAssigned              Lead[]            @relation("AssignedLeads")
  leadsOwned                 Lead[]            @relation("LeadOwner")
  leadActivities             LeadActivity[]    @relation("UserLeadActivities")
  importBatches              ImportBatch[]     @relation("UserImportBatches")
  leadNotes                  LeadNote[]
  leadLosses                 LeadLoss[]
  adminDistributionLogs      DistributionLog[] @relation("AdminDistributionLog")
  consultantDistributionLogs DistributionLog[] @relation("ConsultantDistributionLog")
  leadHistories              LeadHistory[]     @relation("UserLeadHistory")
  leadEvents                 LeadEvent[]       @relation("UserLeadEvents")
}

model Campanha {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  nome           String
  descricao      String?
  parceiro       String?
  objetivo       String?
  vertical       String?
  regiaoUf       String?
  regiaoCidade   String?
  observacoes    String?
  status         String?   @default("ATIVA")
  office         Office?
  periodoInicio  DateTime?
  periodoFim     DateTime?
  createdAt      DateTime  @default(now())
  createdById    String?   @db.ObjectId
  totalLeads     Int       @default(0)
  assignedLeads  Int       @default(0)
  remainingLeads Int       @default(0)
  isActive       Boolean   @default(true)

  leadsBrutos      Lead[]            @relation("CampanhaLeads")
  importBatches    ImportBatch[]
  activities       LeadActivity[]
  distributionLogs DistributionLog[] @relation("CampanhaDistributionLogs")
}

model Lead {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  campanhaId    String       @db.ObjectId
  campanha      Campanha     @relation("CampanhaLeads", fields: [campanhaId], references: [id])
  importBatchId String?      @db.ObjectId
  importBatch   ImportBatch? @relation(fields: [importBatchId], references: [id])

  cnpj           String?
  documento      String?
  razaoSocial    String?
  nomeFantasia   String?
  vertical       String?
  cidade         String?
  estado         String?
  telefone       String?
  email          String?
  telefone1      String?
  telefone2      String?
  telefone3      String?
  logradouro     String?
  numero         String?
  bairro         String?
  cep            String?
  endereco       String?
  territorio     String?
  ofertaMkt      String?
  estrategia     String?
  armario        String?
  idPruma        String?
  vlFatPresumido String?
  cnae           String?

  status             LeadStatus    @default(NOVO)
  consultorId        String?       @db.ObjectId
  consultor          User?         @relation("AssignedLeads", fields: [consultorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ownerId            String?       @db.ObjectId
  owner              User?         @relation("LeadOwner", fields: [ownerId], references: [id])
  officeId           String?       @db.ObjectId
  officeRecord       OfficeRecord? @relation(fields: [officeId], references: [id])
  escritorio         Office        @default(SAFE_TI)
  assignedToId        String?
  previousConsultants String[]     @default([])
  lastActivityDate    DateTime?
  historico          Json?
  raw                Json?
  lastStatusChangeAt DateTime?
  lastInteractionAt  DateTime?
  interactionCount   Int           @default(0)
  isWorked           Boolean       @default(false)
  lastActivityAt     DateTime?
  lastOutcomeCode    String?
  lastOutcomeLabel   String?
  lastOutcomeNote    String?
  nextFollowUpAt     DateTime?
  nextStepNote       String?
  telefones          Json?
  emails             String[]
  lostReason         String?
  lostReasonComment  String?
  lostAt             DateTime?
  site               String?
  contatoPrincipal   Json?
  observacoesGerais  String?
  origem             String?
  externalData       Json?
  productCart        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  activities LeadActivity[]
  events     LeadEvent[]
  enrichmentSuggestions LeadEnrichmentSuggestion[]
  notes      LeadNote[]
  losses     LeadLoss[]
  histories  LeadHistory[]  @relation("LeadToHistories")
}

model LeadEvent {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  leadId    String   @db.ObjectId
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation("UserLeadEvents", fields: [userId], references: [id], onDelete: Cascade)
  type      String
  payload   Json?
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([userId])
}

model LeadEnrichmentSuggestion {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  leadId    String   @db.ObjectId
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String
  source    String
  value     String
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
}

model OfficeRecord {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  code      String   @unique
  region    String?
  uf        String?
  city      String?
  notes     String?
  active    Boolean  @default(true)
  seniorManagerId   String? @db.ObjectId
  seniorManager     User?   @relation("OfficeSeniorManager", fields: [seniorManagerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  businessManagerId String? @db.ObjectId
  businessManager   User?   @relation("OfficeBusinessManager", fields: [businessManagerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ownerId           String? @db.ObjectId
  owner             User?   @relation("OfficeOwner", fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  office    Office?  @map("office")
  users     User[]   @relation("OfficeUsers")
  managers  ManagerOffice[] @relation("ManagerOffices")
  leads     Lead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ManagerOffice {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  managerId      String       @db.ObjectId
  officeRecordId String       @db.ObjectId

  manager      User         @relation("ManagerOffices", fields: [managerId], references: [id], onDelete: Cascade)
  officeRecord OfficeRecord @relation("ManagerOffices", fields: [officeRecordId], references: [id], onDelete: Cascade)

  @@unique([managerId, officeRecordId])
}

model UserOffice {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  office    Office

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, office])
}

model LeadActivity {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  leadId         String           @db.ObjectId
  lead           Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId         String           @db.ObjectId
  user           User             @relation("UserLeadActivities", fields: [userId], references: [id])
  campaignId     String           @db.ObjectId
  campaign       Campanha         @relation(fields: [campaignId], references: [id])
  activityType   String
  channel        ActivityChannel?
  outcomeCode    String?
  outcomeLabel   String?
  note           String
  stageBefore    LeadStatus?
  stageAfter     LeadStatus?
  nextFollowUpAt DateTime?
  nextStepNote   String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([leadId])
  @@index([userId])
  @@index([campaignId])
}

model ImportBatch {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  nomeArquivoOriginal String
  fileName            String?
  campaignId          String   @db.ObjectId
  campaign            Campanha @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  totalLeads          Int
  importedLeads       Int      @default(0)
  attributedLeads     Int      @default(0)
  notAttributedLeads  Int      @default(0)
  duplicatedLeads     Int      @default(0)
  status              String   @default("completed")
  errorMessage        String?
  criadoPorId         String?  @db.ObjectId
  criadoPor           User?    @relation("UserImportBatches", fields: [criadoPorId], references: [id])
  createdAt           DateTime @default(now())
  leads               Lead[]
}

model DistributionLog {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  campaignId   String   @db.ObjectId
  adminId      String   @db.ObjectId
  consultantId String   @db.ObjectId
  leadIds      String[]
  rulesApplied String?
  createdAt    DateTime @default(now())

  campaign   Campanha @relation("CampanhaDistributionLogs", fields: [campaignId], references: [id])
  admin      User     @relation("AdminDistributionLog", fields: [adminId], references: [id])
  consultant User     @relation("ConsultantDistributionLog", fields: [consultantId], references: [id])
}

model LeadHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  leadId    String   @db.ObjectId
  lead      Lead     @relation("LeadToHistories", fields: [leadId], references: [id])
  action    String
  userId    String   @db.ObjectId
  user      User     @relation("UserLeadHistory", fields: [userId], references: [id])
  notes     String?
  fromUserId String?
  toUserId   String?
  byUserId   String?
  date      DateTime @default(now())
  createdAt DateTime @default(now())
}

model LeadNote {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  leadId    String   @db.ObjectId
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  tipo      String
  conteudo  String
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([userId])
}

model LeadLoss {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  leadId        String   @db.ObjectId
  lead          Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id])
  motivo        String
  justificativa String
  createdAt     DateTime @default(now())

  @@index([leadId])
  @@index([userId])
}
